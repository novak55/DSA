#include "pch.h"
#include "ProductList.h"
#include <stddef.h>
#include <iostream>
#include <fstream>
#include <string>

using namespace std;

/**
 * Konstruktor spojovaného seznamu
 */
ProductList::ProductList()
{
	pHead = NULL;
}


/**
 * Destruktor spojovaného seznamu
 */
ProductList::~ProductList()
{
	while (pHead != NULL)
	{
		Product *pTmp = pHead;
		pHead = pHead->pNext;
		delete pTmp; pTmp = NULL;
	}
}

/**
 * Provede nastavení vložených údajù pro položku zboží na skladì
 * @param cislo Evidenèní (identifikaèní) èíslo zboží
 * @param cena  je cena daného kusu zboží na skladì
 * @param pocet zobrazuje poèet kusù zboží na skladì
 * @param popis textový popis daného zboží
 */
void ProductList::NacistUdaje(int cislo, int cena, int pocet, string popis)
{
	this->cislo = cislo;
	this->cena = cena;
	this->pocet = pocet;
	this->popis = popis;
}

/**
 * Provede pøidání záznamu o zboží na skladì
 * @param cislo Evidenèní (identifikaèní) èíslo zboží
 * @param cena  je cena daného kusu zboží na skladì
 * @param pocet zobrazuje poèet kusù zboží na skladì
 * @param popis textový popis daného zboží
 * @return Informace o úspìchu pøidání záznamu o zboží
 */
bool ProductList::Add(int cislo, int cena, int pocet, string popis)
{
	cislo == 0 ? VlozitUdaje() : NacistUdaje(cislo, cena, pocet, popis);
	Product *pNovyProdukt = new Product(this->cislo, this->cena, this->pocet, this->popis);
	Product *pPred = NULL; // ukazatel na predchazejici prvek
	Product *pTmp = pHead; // ukazatel na aktualni (nasledujici) prvek

	if (pHead == NULL)
	{
		// prazdny seznam
		pHead = pNovyProdukt;
		return true;
	}
	else
	{
		while (pTmp->pNext != NULL) {

			if (pTmp->cislo > this->cislo) {
				printf("%d\n", pTmp->cislo);
				break;
			}
			pPred = pTmp;
			pTmp = pTmp->pNext;
		}

		if (pPred == NULL && pTmp->pNext == NULL) { // pouze jeden druh zbozi zatim vlozeny

			if (pTmp->cislo < this->cislo) {
				pTmp->pNext = pNovyProdukt;
				pNovyProdukt->pNext = NULL;
			}
			else {
				pNovyProdukt->pNext = pTmp;
				pHead = pNovyProdukt;
			}
			return true;
		}
		if (pTmp->pNext == NULL) { // davame cislo na konec
			if (pTmp->cislo < this->cislo) {
				pTmp->pNext = pNovyProdukt;
				pNovyProdukt->pNext = NULL;
			}
			else {
				pPred->pNext = pNovyProdukt;
				pNovyProdukt->pNext = pTmp;
			}
			return true;
		}
		if (pPred == NULL) { // davame cislo na zacatek
			pNovyProdukt->pNext = pTmp;
			pHead = pNovyProdukt;
			return true;
		}
		// prvek je vkladan mezi jine prvky
		pPred->pNext = pNovyProdukt;
		pNovyProdukt->pNext = pTmp;
		return true;
	}
	return false;
}

/**
 * Provede odebrání záznamu o zboží na skladì podle jeho evidenèního èísla
 * @param cislo Evidenèní (identifikaèní) èíslo zboží
 * @return Informace o úspìchu odebrání záznamu o zboží
 */
bool ProductList::Remove(int cislo)
{
	Product *pPred = NULL; // ukazatel na predchazejici prvek
	Product *pTmp = pHead; // ukazatel na aktualni (nasledujici) prvek

	while ((pTmp != NULL) && (pTmp->cislo != cislo))
	{
		pPred = pTmp;
		pTmp = pTmp->pNext;
	}

	if (pTmp != NULL)
	{
		if (pTmp == pHead)	
			pHead = pTmp->pNext;
		else
			pPred->pNext = pTmp->pNext;

		delete pTmp;
		return true;
	}
	else
		return false;
}

/**
 * Provede editaci záznamu o zboží na skladì
 * @return Informace o úspìchu provedení úpravy záznamu
 */
bool ProductList::EditProduct()
{ 
	VlozitUdaje();
	Product *pTmp = pHead; // ukazatel na aktualni (nasledujici) prvek
	while ((pTmp != NULL))
	{
		if (pTmp->cislo == cislo) {
			pTmp->cena = cena;
			pTmp->pocet = pocet;
			pTmp->popis = popis;
			return true;
		}
		pTmp = pTmp->pNext;
	}
	return false;
}

/**
 * Provede vyhledání a zobrazení informací o zboží na skladì podle jeho evidenèního èísla
 * @param cislo Evidenèní (identifikaèní) èíslo zboží
 * @return Informace o existenci záznamu o zboží
 */
bool ProductList::FindProduct(int cislo)
{
	Product *pTmp = pHead; // ukazatel na aktualni (nasledujici) prvek
	while ((pTmp != NULL))
	{
		if (pTmp->cislo == cislo) {
			cout << "Zbozi: " << pTmp->popis << ", cislo: " << pTmp->cislo << ", cena: " << pTmp->cena << "Kc, kusu: " << pTmp->pocet << endl;
			return true;
		}
		pTmp = pTmp->pNext;
	}
	return false;
}

/**
 * Provede výpis informací o všech položkách zboží na skladì
 * Zobrazí název zboží, evidenèní èíslo, cenu za kus a poèet kusù
 */
void ProductList::PrintList()
{
	Product *pTmp = pHead;
	while (pTmp != NULL)
	{
		cout << "Zbozi: " << pTmp->popis << ", cislo: " << pTmp->cislo << ", cena: " << pTmp->cena << "Kc, kusu: " << pTmp->pocet << endl;
		pTmp = pTmp->pNext;
	}
}

/**
 * Provede výpoèet celkové sumy ceny zboží na skladì
 * @return Celková suma ceny zboží na skladì
 */
int ProductList::CountSummary()
{
	int summary = 0; // celkova cena zbozi na sklade
	Product * pTmp = pHead;
	while (pTmp != NULL) {
		summary += pTmp->cena * pTmp->pocet;
		pTmp = pTmp->pNext;
	}

	return summary;
}

/**
 * Provede seøazení produktù ve spojovaném seznamu vzestupnì podle hodnoty klíèe
 */
void ProductList::SortByKeyAsc()
{
	Product * j;
	Product * i = pHead;

	for (i = pHead; i != NULL; i = i->pNext) {
		for (j = i->pNext; j != NULL; j = j->pNext) {
			if (i->cislo > j->cislo) {
				swap(i->cislo, j->cislo);
				swap(i->cena, j->cena);
				swap(i->pocet, j->pocet);
			}
		}
	}
}

/**
 * Provede seøazení produktù ve spojovaném seznamu sestupnì podle hodnoty klíèe
 */
void ProductList::SortByKeyDes()
{
	Product * j;
	Product * i = pHead;

	for (i = pHead; i != NULL; i = i->pNext) {
		for (j = i->pNext; j != NULL; j = j->pNext) {
			if (i->cislo < j->cislo) {
				swap(i->cislo, j->cislo);
				swap(i->cena, j->cena);
				swap(i->pocet, j->pocet);
			}
		}
	}
}

/**
 * Provede import dat z externího souboru do spojovaného seznamu
 * @return Informace o úspìchu provedení importu dat
 */
bool ProductList::ImportData()
{
	ifstream dataInput("data.csv");
	if (!dataInput.is_open()) {
		cout << "Chyba: Soubor neotevren!" << '\n';
		return false;
	}
	string cisloS;
	string cenaS;
	string pocetS;
	string popisS;
	while (dataInput.good()) {
		int soucet = 0;
		getline(dataInput, cisloS, ';');
		getline(dataInput, cenaS, ';');
		getline(dataInput, pocetS, ';');
		getline(dataInput, popisS, '\n');
		
		try
		{
			Add(stoi(cisloS), stoi(cenaS), stoi(pocetS), popisS);
		}
		catch (exception)
		{
			dataInput.close();
			cout << "Sklad je prazdny, neni mozne nacist zadna data.\n" << endl;
			return false;
		}
	}
	PrintList();
	dataInput.close();
	return true;
}

/**
 * TODO
 *
 */
int ProductList::ZadatCiselnouHodnotu(int min = 0) {
	string s;
	int i;
	while (true)
	{
		try
		{
			cin >> s;
			i = stoi(s);
			if (i >= min)
				return i;
			else cout << "Zadana hodnota musi byt cele cislo vetsi nebo rovno " << min << ". Zadejte prosim znovu: ";
		}
		catch (invalid_argument & exception)
		{
			cout << "Nebylo zadano cislo. Zadejte prosim znovu: ";
		}
		catch (out_of_range & exception)
		{
			cout << "Cislo je prilis velke (nebo prilis male). Zadejte prosim znovu:  ";
		}
	}

}


/**
 * TODO
 */
void ProductList::VlozitUdaje() {
	cout << "Zadejte cislo produktu: ";
	this->cislo = ZadatCiselnouHodnotu(1);
	cout << "Zadejte cenu produktu: ";
	this->cena = ZadatCiselnouHodnotu(1);
	cout << "Zadejte pocet kusu produktu: ";
	this->pocet = ZadatCiselnouHodnotu(1);
	cout << "Zadejte popis produktu: ";
	getline(cin >> ws, this->popis);
}


/**
 * Provede export dat ze spojovaného seznamu zboží na skladì do externího souboru
 * @return Informace o úspìchu provedení exportu dat
 */
bool ProductList::ExportData() {
	fstream soubor("data.csv", ios::out);
	if (!soubor.is_open()) {
		cout << "Chyba: Soubor neotevren!" << '\n';
		return false;
	}
	Product* pTmp = pHead;
	bool novyRadek = false;
	while (pTmp != NULL) {
		if (novyRadek)
			soubor << endl; 
		else novyRadek = true;
		soubor << pTmp->cislo <<";" << pTmp->cena << ";" << pTmp->pocet << ";" << pTmp->popis;
		pTmp = pTmp->pNext;
	}

	soubor.close();
	cout << "\nData jsou ulozena\n" << endl;
	return true;
}